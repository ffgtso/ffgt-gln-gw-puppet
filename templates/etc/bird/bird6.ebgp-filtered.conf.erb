# this is file is generated by puppet

template bgp ebgp_filt {
  table mesh;
  local as <%= @our_as %>;
  import none;
  export none;
  next hop self;
}

define BOGON_ASNS = [0, 23456, 64496..131071, 4200000000..4294967295];

<% peerings = YAML.load_file(@gre_yaml); -%>
<% peerings.each_pair do |tunnelname,node| -%>
filter peer_in_AS<%=node['peeras']%>
prefix set <%=node['import6']%>_PFX;
int set bogon_asns;
{
  # Scrub BLACKHOLE Community from peering partners
  bgp_community.delete((65535, 666));

<% if defined?(node['import_filter6']) -%>
  include "/etc/bird/bird6.conf.d/<%=node['import_filter6']%>";
<% end -%>

  # ignore bogon AS_PATHs
  bogon_asns = BOGON_ASNS;
  if ( bgp_path ~ bogon_asns ) then {
    print "Reject: bogon AS_PATH: ", net, " ", bgp_path;
    reject;
  }
<% if defined?(node['import6']) -%>
<% if node['import6'] == "ANY" -%>
  if avoid_martians() then {
    if (net ~ 2000::/3{12,48}) then {
      accept;
    }
  }
<% else -%>
  include "/etc/bird/bird6.conf.d/<%= node['import6'] %>_PFX6.inc";
  if (net ~ <%= node['import6'].gsub('-', '_').gsub(':', '__') %>_PFX) then {
    bgp_med = 0;
    bgp_local_pref = 100;
    # Scrub BGP Communities (RFC 7454 Section 11)
    bgp_community.delete([(<%=@our_as%>, *)]);
    bgp_large_community.delete([(<%=@our_as%>, *, *)]);
    bgp_community.add((<%=@our_as%>,1)); /* mark peering routes as peering routes */
    bgp_large_community.add((<%=@our_as%>, 0, 1)); /* mark peering routes as peering routes */
    accept;
  }
<% end -%>
<% else -%>
  # No import6: line found
<% end -%>
}

filter peer_out_AS<%=node['peeras']%>
prefix set <%=node['export6']%>_PFX;
int set bogon_asns;
{
<% if defined?(node['export_filter6']) -%>
  include "/etc/bird/bird6.conf.d/<%=node['export_filter6']%>";
<% end -%>

<% if @sitelocal_prefix != "none" -%>
  if (net ~ [ <%=@sitelocal_prefix%> ] then accept;
<% end -%>
<% if @no_export_prefix != "none" -%>
  if (net ~ [ <%=@no_export_prefix%> ] then reject;
<% end -%>
 if ((<%=@our_as%>, 2, <%=node['peeras']%>) ~ bgp_large_community || (<%=@our_as%>, 2, 0) ~ bgp_large_community) then {
    bgp_path.prepend(<%=@our_as%>);
  } else if ((<%=@our_as%>, 3, <%=node['peeras']%>) ~ bgp_large_community || (8283, 3, 0) ~ bgp_large_community) then {
    bgp_path.prepend(<%=@our_as%>);
    bgp_path.prepend(<%=@our_as%>);
  }
  if ((<%=@our_as%>, 4, peerasn) ~ bgp_large_community || (<%=@our_as%>, 4, 0) ~ bgp_large_community) then {
    reject;
  }

  # ignore bogon AS_PATHs
  bogon_asns = BOGON_ASNS;
  if ( bgp_path ~ bogon_asns ) then {
    print "Reject: bogon AS_PATH: ", net, " ", bgp_path;
    reject;
  }
<% if defined?(node['export6']) -%>
<% if node['export6'] == "ANY" -%>
  martians = [ ::1/128, ::/128, ::ffff:0:0/96+, 100::/64+,
       2001:db8::/32+, 2001::/23, 2001:2::/48+, 64:ff9b::/96{96,128},
       2001:10::/28+, 2002::/17+, fc00::/7, fe80::/10, ff00::/8+,
       3FFE::/16+, 5F00::/8+, ::/0{0,15}, ::/0{49,128} ];

  if net ~ martians then reject;
  if (net ~ 2000::/3{12,48}) then {
    accept;
  }
<% else -%>
  include "/etc/bird/bird6.conf.d/<%=node['export6']%>_PFX6.inc";
  if (net ~ <%=node['export6'].gsub('-', '_').gsub(':', '__')%>_PFX) then {
    accept;
  }
<% end -%>
<% else -%>
  # No export6: line found
<% end -%>
}

protocol bgp e_<%= node['name'].gsub('-', '_') %> from ebgp_filt {
<% if defined?(node['ouras']) -%>
  local as <%= node['ouras'] %>;
<% end -%>
  source address <%= node['ipv6src'] %>;
  neighbor <%= node['ipv6dst'] %><% if node['ipv6dst'].match(/^fe80/i) %> % '<%= tunnelname %>'<% end -%> as <%= node['peeras'] %>;
  import keep filtered;
  import filter peer_in_AS<%=node['peeras']%>;
  export filter peer_out_AS<%=node['peeras']%>;
<% if defined?(node['multihop']) -%>  multihop <%= node['multihop'] %>;
<% end -%>
<% if defined?(node['passwd']) -%>  password "<%= node['passwd'] %>";
<% end -%>
<% if defined?(node['export_limit6']) -%>  export limit <%=node['export_limit6']%> action block;
<% end -%>
};


<% end -%>
