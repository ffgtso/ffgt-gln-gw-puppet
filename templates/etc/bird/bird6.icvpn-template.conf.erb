# this is file is generated by puppet

# return true if between /19 and /64
function in_prefix_range_icvpn() {
  if net.len < 19 then return false;
  if net.len > 64 then return false;
  return true;
}

# template for icvpn route exchange via bgp
template bgp icvpn {
  table mesh;
  local as <%= @icvpn_as %>;
  source address <%= @icvpn_ipv6_address %>;
  import keep filtered;
  import filter {
    <% if @allow_v6_default == "yes" %>if is_default() then accept;
    <% end %>if in_prefix_range_icvpn() && (is_ula() || is_freifunk()) then accept;
  };
  export filter {
    if is_default() then reject;
    if in_prefix_range_icvpn() then {
      <% @export_prefixes.each do |prefix| %>if (net ~ [ <%= prefix %> ]) then accept;
      <% end %>if is_in_<%= @mesh_code %>_upstream_prefix() then accept;
      if ((source = RTS_BGP || source = RTS_STATIC_DEVICE || source = RTS_STATIC) && (is_freifunk() || is_ula()<% if @include_chaos == "yes" %> || is_chaos()<% end %><% if @include_dn42 == "yes" %> || is_dn42()<% end %>)) then accept;
    }
    reject;
  };
};
