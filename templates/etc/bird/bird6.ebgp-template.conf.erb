# this is file is generated by puppet

<% peerings = YAML.load_file(@gre_yaml); -%>
<% peerings.each_pair do |gretun,node| -%>
<% @peers.each do |tunnel,args| -%>
<% if gretun == tunnel -%>
<% array = args.split(';') %>
protocol bgp e_<%= @name.gsub('-', '_') %>_<%= tunnel.gsub('-', '_') %> from ebgp<% if @type == "special" -%>_<%= @name.gsub('-', '_') %><% end -%> {
  source address <%= node['ipv6src'] %>;
  neighbor <%= node['ipv6dst'] %><% if node['ipv6dst'].match(/^fe80/i) %> % '<%= tunnel %>'<% end -%> as <%= array[0] %>;
  export limit <% if @export_limit == "" -%>24<% else -%><%=@export_limit%><% end -%> action block;
  import keep filtered;
  #import filter import_ebgp_<% if @type == "special" -%><%= @name.gsub('-', '_') %><% else %><%= @type %><% end -%>;
  #export filter export_ebgp_<% if @type == "special" -%><%= @name.gsub('-', '_') %><% else %><%= @type %><% end -%>;
  import filter {
    if pass_imp_ebgp_<% if @type == "special" -%><%= @name.gsub('-', '_') %><% else %><%= @type %><% end -%>(<% if @dfz != ""-%>1<% else -%>0<% end -%>) then accept;
  };
  export filter {
<% if @dont_export_prefix != "none"-%>
    if (net ~ [<%= @dont_export_prefix %>]) then reject;

<% end -%>
    if (source = RTS_BGP || source = RTS_DEVICE || source = RTS_STATIC) then {
<% @peers.each do |tunnel,args| -%>
<% array = args.split(';') -%>
<% if array[2].to_s != "" -%>
<% exports = array[2].split(',') -%>
<% exports.each do |expnet| -%>
<% if expnet.match(/{/i) -%>
      if (net ~ [<%= expnet.gsub('_', ',')  %>] && ok_for_ebgp_export()) then accept;
<% else -%>
      if (net = <%= expnet %> && ok_for_ebgp_export()) then accept;
<% end -%>
<% end -%>
<% end -%>
<% end -%>
      if pass_exp_ebgp_<% if @type == "special" -%><%= @name.gsub('-', '_') %><% else %><%= @type %><% end -%>(<% if @dfz != ""-%>1<% else -%>0<% end -%>) then accept;
    }
    reject;
  };
<% if array[1].to_s != "" -%>  default bgp_local_pref <%= array[1] %>;
<% end -%>
<% if @multihop != "" -%>
<% if @multihop == "true" || @multihop == "yes" -%>    multihop;
<% else -%>    multihop <%= @multihop %>;
<% end -%>
<% end -%>
<% if @password != "" -%>    password "<%= @password %>";
<% end -%>
<% if @bgp_options != "" -%>  <%= @bgp_options %>
<% end -%>
};
<% end -%>
<% end -%>
<% end -%>
