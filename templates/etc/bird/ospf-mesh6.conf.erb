# this file is generated by puppet
# bird OSPF configuration

filter ex_ospf_<%= @mesh_code.gsub('-', '_') %>_root {
  if is_default() then accept;
  #if is_default() && source = RTS_BGP then accept;
<% @mynets.each do |prefix| %>  if (net ~ [<%= prefix %>]) then accept;<% end %>
  reject;
}

filter im_ospf_<%= @mesh_code.gsub('-', '_') %>_root {
<% @mynets.each do |prefix| %>  if (net ~ [<%= prefix %>]) then accept;<% end %>
  reject;
}

filter ex_ospf_<%= @mesh_code.gsub('-', '_') %>_leaf {
<% @mynets.each do |prefix| %>  if (net ~ [<%= prefix %>]) then accept;<% end %>
  reject;
}

filter im_ospf_<%= @mesh_code.gsub('-', '_') %>_leaf {
  if is_default() then accept;
<% @mynets.each do |prefix| %>  if (net ~ [<%= prefix %>]+) then accept;<% end %>
  reject;
}

<% if @have_ospf_peerings == "yes" -%>
protocol ospf o_p_<%= @mesh_code.gsub('-', '_') %> {
  table mesh;
  import keep filtered;
  import filter im_ospf_<%= @mesh_code.gsub('-', '_') %>_<%=@ospf_type%>;
  export filter ex_ospf_<%= @mesh_code.gsub('-', '_') %>_<%=@ospf_type%>;
  instance id 0;

  area 0 {
#    networks {
#<% @mynets.each do |prefix| %>  <%= prefix %>;<% end %>
#    };
<% peerings = YAML.load_file(@ospf_peerings); -%>
<% peerings.each_pair do |name,node| -%>
    interface "<%=name%>" {
      cost <%= node['cost'] %>;
      type pointopoint;
      hello 5; retransmit 2; wait 10; dead 20;
      check link;
      authentication none;
    };
<% end -%>
  };
}
<% end -%>

<% if @have_ospf_links == "yes" -%>
protocol ospf o_l_<%= @mesh_code.gsub('-', '_') %> {
  table mesh;
  import keep filtered;
  import filter im_ospf_<%= @mesh_code.gsub('-', '_') %>_<%=@ospf_type%>;
  export filter ex_ospf_<%= @mesh_code.gsub('-', '_') %>_<%=@ospf_type%>;
  instance id 10;

  # Links between bgp? & gw??
  area 10 {
<% peerings = YAML.load_file(@ospf_links); -%>
<% peerings.each_pair do |name,node| -%>
    interface "<%=name%>" {
      cost <%= node['cost'] %>;
      type pointopoint;
      hello 5; retransmit 2; wait 10; dead 20;
      check link;
      authentication none;
    };

<% end -%>
  };
}
<% end -%>