# this file is generated by puppet

# bird OSPF configuration

table ospf_<%= @mesh_code %>;

# pipe between mesh and ospfmesh_<%= @mesh_code %> table
# import all from mesh, export from ospf_xxxx to mesh own network and default route(s)
protocol pipe pipe_ospf_<%=@mesh_code%> {
  table mesh;
  peer table ospf_<%= @mesh_code %>;
  import all; # where ! is_self_<%=@mesh_code %>();
  export filter {
    if is_self_<%=@mesh_code %>() then accept;
    <% if @have_ospf_peerings == "yes" %>if is_default() && (source == RTS_OSPF && ospf_tag == 0) then accept;<% end -%>;
  };
  }
};

<% if @have_ospf_peerings == "yes" %>
<% peerings = YAML.load_file(@ospf_peerings); -%>
<% peerings.each_pair do |name,node| -%>
protocol static ospf_<%=name%> {
  import all;
  table ospf_<%= @mesh_code %>;
  route <%= node['ipv4src'] %>/32 via "ospf-<%=name%>";
  route <%= node['ipv4dst'] %>/32 via "ospf-<%=name%>";
}
<% end -%>

protocol ospf bb_<%= @mesh_code %> {
  table ospf_<%= @mesh_code %>;
  import all;
  #import where !is_default();
  export filter {
    if (source = RTS_STATIC || is_in_<%= @mesh_code %>_prefix() || is_default()) then accept;
    reject;
  };

  # Backbone
  area 0 {
    networks {
      <%= @range_ipv4 %>;
    };
<% peerings = YAML.load_file(@ospf_peerings); -%>
<% peerings.each_pair do |name,node| -%>
    interface "ospf-<%=name%>" {
      cost <%= node['cost'] %>;
      type pointopoint;
      hello 5; retransmit 2; wait 10; dead 20;
      check link;
      authentication none;
    };

<% end -%>
    interface "icvpn" {
      cost 70;
      stub;
    };
  };
}
<% end %>

<% if @have_ospf_links == "yes" %>
<% peerings = YAML.load_file(@ospf_links); -%>
<% peerings.each_pair do |name,node| -%>
protocol static ospf_<%=name%> {
  table ospf_<%= @mesh_code %>;
  import all;
  route <%= node['ipv4src'] %>/32 via "ospf-<%=name%>";
  route <%= node['ipv4dst'] %>/32 via "ospf-<%=name%>";
}
<% end -%>

protocol ospf int_<%= @mesh_code %> {
  table ospf_<%= @mesh_code %>;
  import all;
  #import where !is_default();
#  export all;
  export filter {
    ospf_tag = 10;
    if (source = RTS_STATIC || is_in_<%= @mesh_code %>_prefix() || is_default()) then accept;
    reject;
  };

  # Links between bgp? & gw??
  area 10 {
<% peerings = YAML.load_file(@ospf_links); -%>
<% peerings.each_pair do |name,node| -%>
    interface "ospf-<%=name%>" {
      cost <%= node['cost'] %>;
      type pointopoint;
      hello 5; retransmit 2; wait 10; dead 20;
      check link;
      authentication none;
    };

<% end -%>
    interface "br-<%= @mesh_code %>" {
      cost 70;
      stub;
    };
  };
}
<% end %>
