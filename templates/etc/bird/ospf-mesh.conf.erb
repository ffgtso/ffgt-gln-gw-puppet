# this file is generated by puppet
# bird OSPF configuration

function ok_to_export_<%= @mesh_code.gsub('-', '_') %>_ospf() {
<% if @dont_export_prefix != "none" -%>
  if (net ~ [<%= @dont_export_prefix %>]) then return false;
<% end -%>
  return true;
}

<% if @have_ospf_peerings == "yes" -%>
filter ex_ospf_<%= @mesh_code.gsub('-', '_') %>_root {
<% if @ospf_export_filter != "" -%>
  include "/etc/bird/bird.conf.d/<%=@ospf_export_filter%>";

<% end -%>
  if (source = RTS_BGP) then reject;
  if (proto = "o_p_<%= @mesh_code.gsub('-', '_') %>") then reject;
  accept;
}

filter im_ospf_<%= @mesh_code.gsub('-', '_') %>_root {
<% if @ospf_import_filter != "" -%>
  include "/etc/bird/bird.conf.d/<%=@ospf_import_filter%>";

<% end -%>
  accept;
}
<% end -%>

<% if @have_ospf_links == "yes" -%>
filter ex_ospf_<%= @mesh_code.gsub('-', '_') %>_leaf {
<% if @ospf_export_filter != "" -%>
  include "/etc/bird/bird.conf.d/<%=@ospf_export_filter%>";

<% end -%>
<% if @dfz == "" -%>
  if is_default() then accept;
<% end -%>
  if (source = RTS_BGP) then reject;
  if (proto = "o_l_<%= @mesh_code.gsub('-', '_') %>") then reject;
  accept;
}

filter im_ospf_<%= @mesh_code.gsub('-', '_') %>_leaf {
<% if @ospf_import_filter != "" -%>
  include "/etc/bird/bird.conf.d/<%=@ospf_import_filter%>";

<% end -%>
#<% if @dfz == "" -%>
  if is_default() then accept;
#<% end -%>
  accept;
}
<% end -%>

<% if @have_ospf_peerings == "yes" -%>
protocol ospf o_p_<%= @mesh_code.gsub('-', '_') %> {
  table mesh;
  import keep filtered;
  import filter im_ospf_<%= @mesh_code.gsub('-', '_') %>_root;
  export filter ex_ospf_<%= @mesh_code.gsub('-', '_') %>_root;
<% if @ospf_instance_id == "" -%>
  instance id 0;
<% else -%>
  instance id <%=@ospf_instance_id%>;
<% end -%>

  area 0 {
#    networks {
#<% @mynets.each do |prefix| %>  <%= prefix %>;<% end %>
#    };
<% peerings = YAML.load_file(@ospf_peerings); -%>
<% peerings.each_pair do |name,node| -%>
    interface "<%=name%>" {
      cost <%= node['cost'] %>;
<% if defined?(node['type']) && node['type'] -%>
      type <%= node['type'] %>;
<% else -%>
      type pointopoint;
<% end -%>
      hello 5; retransmit 2; wait 10; dead 20;
      #check link;
    };
<% end -%>
  };
}
<% end -%>

<% if @have_ospf_links == "yes" -%>
protocol ospf o_l_<%= @mesh_code.gsub('-', '_') %> {
  table mesh;
  import keep filtered;
  import filter im_ospf_<%= @mesh_code.gsub('-', '_') %>_leaf;
  export filter ex_ospf_<%= @mesh_code.gsub('-', '_') %>_leaf;
<% if @ospf_instance_id == "" -%>
  instance id 10;
<% else -%>
  instance id <%=@ospf_instance_id%>;
<% end -%>

  # Links between bgp? & gw??
<% if @ospf_int_area == "" -%>
  area 10 {
<% else -%>
  area <%=@ospf_int_area%> {
<% end -%>
<% peerings = YAML.load_file(@ospf_links); -%>
<% peerings.each_pair do |name,node| -%>
    interface "<%=name%>" {
      cost <%= node['cost'] %>;
<% if defined?(node['type']) && node['type'] -%>
      type <%= node['type'] %>;
<% else -%>
      type pointopoint;
<% end -%>
      hello 5; retransmit 2; wait 10; dead 20;
      #check link;
    };

<% end -%>
  };
}
<% end -%>