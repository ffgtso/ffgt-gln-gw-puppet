# this is file is generated by puppet

# return true on any route ...
function in_prefix_range_ibgp() {
#  if net.len < 16 then return false;
#  if net.len > 64 then return false;
  return true;
}

# template for ibgp route exchange
template bgp ibgp {
  table mesh;
  local as <%= @icvpn_as %>;
  import filter {
    if is_default() then accept;
    if in_prefix_range_ibgp() then accept;
    reject;
  };
  export filter {
    if is_default() then accept;
    if in_prefix_range_ibgp() then accept;
    reject;
  };
};

<% peerings = YAML.load_file(@gre_yaml); -%>
<% peerings.each_pair do |gretun,node| -%>
<% @routes.each do |tunnel,pref| -%>
<% if gretun == tunnel -%>

protocol bgp 'ibgp_<%= tunnel %>' from ibgp {
    source address <%= node['ipv6src'] %>;
    neighbor <%= node['ipv6dst'] %> as <%= @icvpn_as %>;
    ldefault bgp_local_pref <%= pref %>;
}
<% end -%>
<% end -%>
<% end -%>
