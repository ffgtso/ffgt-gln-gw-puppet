#!/bin/sh
# this file is generated by puppet
# Helper script to update the peer AS prefixes

TMPFILE="/tmp/peerasn-v4.$(date +%Y%m%d%H%M%S)"
AGETHRESHOLD=$(date +%s)
AGETHRESHOLD=$(expr $AGETHRESHOLD - 3600)

for i in <% peerings = YAML.load_file(@gre_yaml); -%>
<% peerings.each_pair do |name,node| -%>
<% if defined?(node['import4']) -%> <%=node['import4']-%><% end -%>
<% if defined?(node['export4']) -%> <%=node['export4']-%><% end -%>
<% end -%> ; do echo $i | egrep -v 'DEFONLY|ANY' ; done | sort -u >$TMPFILE

for i in $(cat $TMPFILE)
do
  birdname="$(echo $i | sed -e s/:/__/g -e s/-/_/g)"
  destfile="/etc/bird/bird.conf.d/${i}_PFX4.inc"
  if [ -e ${destfile} ] ; then
    FILEAGE=$(stat --printf=%Y ${destfile})
    if [ $FILEAGE -lt $AGETHRESHOLD ]; then
      /usr/bin/bgpq3 -b -4 -l ${birdname}_PFX ${i} >${destfile}
      if [ $(wc -l <${destfile}) -le 2 ]; then
        echo >${destfile} "${birdname}_PFX = [ 100.100.100.100/32 ];"
      fi
    fi
  fi
done
/bin/rm $TMPFILE
