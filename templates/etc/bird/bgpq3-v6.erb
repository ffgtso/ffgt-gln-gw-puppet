#!/bin/sh
# this file is generated by puppet
# Helper script to update the peer AS prefixes

TMPFILE="/tmp/peerasn-v6.$(date +%Y%m%d%H%M%S)"

for i in <% peerings = YAML.load_file(@gre_yaml); -%>
<% peerings.each_pair do |name,node| -%>
<% if defined?(node['import6']) -%> <%=node['import6']-%><% end -%>
<% if defined?(node['export6']) -%> <%=node['export6']-%><% end -%>
<% end -%> ; do echo $i | grep -v ANY ; done | sort -u >$TMPFILE

for i in $(cat $TMPFILE)
do
  birdname="$(echo $i | sed -e s/:/__/g -e s/-/_/g)"
  /usr/bin/bgpq3 -b -6 -l ${birdname}_PFX ${i} >/etc/bird/bird6.conf.d/${i}_PFX6.inc
  if [ $(wc -l </etc/bird/bird6.conf.d/${i}_PFX6.inc) -eq 2 ]; then
    echo >/etc/bird/bird6.conf.d/${i}_PFX6.inc "${birdname}_PFX = [ deca:fbad::15:bad1/128 ];"
  fi
done
/bin/rm $TMPFILE
