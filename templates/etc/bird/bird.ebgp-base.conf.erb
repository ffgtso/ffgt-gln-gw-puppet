# this is file is generated by puppet

# return true on any route ...
function in_prefix_range_ebgp() {
  if net.len < 8 then return false;
  if net.len > 24 then return false;
  return true;
}

<% if @ipv4_main_prefix.to_s != "" -%>
# FIXME, this is basically a duplicate.
protocol static local_<%= @mesh_code.gsub('-', '_') %>_2 {
  table mesh;
  # reject route if announced from external
  route <%= @ipv4_main_prefix %> reject;
};

<% end -%>

#function rt_import(int asn; int set peer_asns; prefix set peer_nets)
#{
#  if ! (net ~ peer_nets) then return false;
#  if ! (bgp_path.last ~ peer_asns) then return false;
#  if bgp_path.first != asn then return false;
#  if bgp_path.len > 64 then return false;
#  if bgp_next_hop != from then return false;
#  return true;
#}

#function rt_import_all(int asn)
#{
#  if net_martian() || net_local() then return false;
#  if bgp_path.first != asn then return false;
#  if bgp_path.len > 64 then return false;
#  if bgp_next_hop != from then return false;
#  return true;
#}


filter import_ebgp_friend {
  if is_default() then accept;
  if is_global_unicast() && in_prefix_range_ebgp() then accept;
  reject;
}

function pass_imp_ebgp_friend(int dfz) {
  if (dfz != 1) then { if is_default() then return true; }
  if is_global_unicast() && in_prefix_range_ebgp() then return true;
  return false;
}


filter export_ebgp_friend {
  if is_default() then accept;
  if ok_for_ebgp_export() then accept;
  reject;
}

function pass_exp_ebgp_friend(int dfz) {
  if (dfz != 1) then { if is_default() then return true; }
  if ok_for_ebgp_export() then return true;
  return false;
}


filter import_ebgp_friend_DFZ {
  if is_global_unicast() && in_prefix_range_ebgp() then accept;
  reject;
}

filter export_ebgp_friend_DFZ {
  if is_global_unicast() && in_prefix_range_ebgp() then accept;
  reject;
}


filter import_ebgp_peer {
  if is_global_unicast() && ! is_in_<%= @mesh_code.gsub('-', '_') %>_prefix() then accept;
  reject;
}

function pass_imp_ebgp_peer(int dfz) {
  if (dfz != 1) then { if is_default() then return true; }
  if is_global_unicast() && ! is_in_<%= @mesh_code.gsub('-', '_') %>_prefix() then return true;
  return false;
}

filter export_ebgp_peer {
  if is_self_<%= @mesh_code.gsub('-', '_') %>() then accept;
  reject;
}

function pass_exp_ebgp_peer(int dfz) {
  if (dfz != 1) then { if is_default() then return true; }
  if is_self_<%= @mesh_code.gsub('-', '_') %>() && ok_for_ebgp_export() then return true;
  return false;
}


filter import_ebgp_transit {
  if is_global_unicast() && in_prefix_range_ebgp() then accept;
  reject;
}

function pass_imp_ebgp_transit(int dfz) {
  if is_global_unicast() && in_prefix_range_ebgp() then return true;
  return false;
}

filter export_ebgp_transit {
  if (source = RTS_BGP || source = RTS_DEVICE || source = RTS_STATIC) then {
    if in_prefix_range_ebgp() && ok_for_ebgp_export() then accept;
  }
  reject;
}

function pass_exp_ebgp_transit(int dfz) {
  if in_prefix_range_ebgp() && ok_for_ebgp_export() then return true;
  return false;
}


filter import_ebgp_upstream {
  if is_default() then accept;
  if is_global_unicast() && in_prefix_range_ebgp() then accept;
  reject;
}

function pass_imp_ebgp_upstream(int dfz) {
  if (dfz != 1) then { if is_default() then return true; }
  if is_global_unicast() && in_prefix_range_ebgp() then return true;
  return false;
}

filter export_ebgp_upstream {
  if (source = RTS_BGP || source = RTS_DEVICE || source = RTS_STATIC) then {
    if is_self_<%= @mesh_code.gsub('-', '_') %>() then accept;
  }
  reject;
}

function pass_exp_ebgp_upstream(int dfz) {
  if is_self_<%= @mesh_code.gsub('-', '_') %>() && ok_for_ebgp_export() then return true;
  return false;
}


# template for ebgp route exchange
template bgp ebgp {
  table mesh;
  local as <%= @our_as %>;
};
